--- libindicate-0.2.3/configure.ac.wiget	2009-10-01 21:52:53.000000000 +0200
+++ libindicate-0.2.3/configure.ac	2009-12-07 20:30:38.000000000 +0100
@@ -75,29 +75,7 @@ AC_SUBST(LIBINDICATEGTK_LIBS)
 # GObject Introspection
 ###########################
 
-AC_ARG_ENABLE(gobject-introspection, AC_HELP_STRING([--enable-gobject-introspection], [enable building the gobject-introspection files]), [enable_gir=$enableval], [enable_gir=yes])
-
-if test "x$enable_gir" = "xyes"; then
-	PKG_CHECK_MODULES(GOBJECT_INTROSPECTION, [gobject-introspection-1.0 >= 0.6], gir_ok=yes, gir_ok=no)
-
-	if test "x$gir_ok" = "xyes"; then
-		G_IR_SCANNER=`$PKG_CONFIG --variable=g_ir_scanner gobject-introspection-1.0`
-		AC_SUBST(G_IR_SCANNER)
-		G_IR_COMPILER=`$PKG_CONFIG --variable=g_ir_compiler gobject-introspection-1.0`
-		AC_SUBST(G_IR_COMPILER)
-		G_IR_GENERATE=`$PKG_CONFIG --variable=g_ir_generate gobject-introspection-1.0`
-		AC_SUBST(G_IR_GENERATE)
-
-		GIRDIR=`$PKG_CONFIG --variable=girdir gobject-introspection-1.0`
-		AC_SUBST(GIRDIR)
-		TYPELIBDIR="$($PKG_CONFIG --variable=typelibdir gobject-introspection-1.0)"
-		AC_SUBST(TYPELIBDIR) 
-	fi
-else
-	gir_ok=no
-fi
-
-AM_CONDITIONAL(USE_GIR, test "x$gir_ok" = "xyes")
+GOBJECT_INTROSPECTION_CHECK([0.6.3])
 
 ###########################
 # GTK Doc 
@@ -178,5 +156,5 @@ AC_MSG_NOTICE([
 Libindicate Configuration:
 
 	Prefix:                 $prefix
-	GObject Introspection:  $gir_ok
+	GObject Introspection:  $enable_introspection
 ])
--- libindicate-0.2.3/m4/introspection.m4.wiget	2009-12-07 20:30:38.000000000 +0100
+++ libindicate-0.2.3/m4/introspection.m4	2009-12-07 20:30:38.000000000 +0100
@@ -0,0 +1,88 @@
+dnl -*- mode: autoconf -*-
+dnl Copyright 2009 Johan Dahlin
+dnl
+dnl This file is free software; the author(s) gives unlimited
+dnl permission to copy and/or distribute it, with or without
+dnl modifications, as long as this notice is preserved.
+dnl
+
+# serial 1
+
+m4_define([_GOBJECT_INTROSPECTION_CHECK_INTERNAL],
+[
+    AC_BEFORE([AC_PROG_LIBTOOL],[$0])dnl setup libtool first
+    AC_BEFORE([AM_PROG_LIBTOOL],[$0])dnl setup libtool first
+    AC_BEFORE([LT_INIT],[$0])dnl setup libtool first
+
+    dnl enable/disable introspection
+    m4_if([$2], [require],
+    [dnl
+        enable_introspection=yes
+    ],[dnl
+        AC_ARG_ENABLE(introspection,
+                  AS_HELP_STRING([--enable-introspection[=@<:@no/auto/yes@:>@]],
+                                 [Enable introspection for this build]),, 
+                                 [enable_introspection=auto])
+    ])dnl
+
+    AC_MSG_CHECKING([for gobject-introspection])
+
+    dnl presence/version checking
+    AS_CASE([$enable_introspection],
+    [no], [dnl
+        found_introspection="no (disabled, use --enable-introspection to enable)"
+    ],dnl
+    [yes],[dnl
+        PKG_CHECK_EXISTS([gobject-introspection-1.0],,
+                         AC_MSG_ERROR([gobject-introspection-1.0 is not installed]))
+        PKG_CHECK_EXISTS([gobject-introspection-1.0 >= $1],
+                         found_introspection=yes,
+                         AC_MSG_ERROR([You need to have gobject-introspection >= $1 installed to build AC_PACKAGE_NAME]))
+    ],dnl
+    [auto],[dnl
+        PKG_CHECK_EXISTS([gobject-introspection-1.0 >= $1], found_introspection=yes, found_introspection=no)
+    ],dnl
+    [dnl	
+        AC_MSG_ERROR([invalid argument passed to --enable-introspection, should be one of @<:@no/auto/yes@:>@])
+    ])dnl
+
+    AC_MSG_RESULT([$found_introspection])
+
+    INTROSPECTION_SCANNER=
+    INTROSPECTION_COMPILER=
+    INTROSPECTION_GENERATE=
+    INTROSPECTION_GIRDIR=
+    INTROSPECTION_TYPELIBDIR=
+    if test "x$found_introspection" = "xyes"; then
+       INTROSPECTION_SCANNER=`$PKG_CONFIG --variable=g_ir_scanner gobject-introspection-1.0`
+       INTROSPECTION_COMPILER=`$PKG_CONFIG --variable=g_ir_compiler gobject-introspection-1.0`
+       INTROSPECTION_GENERATE=`$PKG_CONFIG --variable=g_ir_generate gobject-introspection-1.0`
+       INTROSPECTION_GIRDIR=`$PKG_CONFIG --variable=girdir gobject-introspection-1.0`
+       INTROSPECTION_TYPELIBDIR="$($PKG_CONFIG --variable=typelibdir gobject-introspection-1.0)"
+    fi
+    AC_SUBST(INTROSPECTION_SCANNER)
+    AC_SUBST(INTROSPECTION_COMPILER)
+    AC_SUBST(INTROSPECTION_GENERATE)
+    AC_SUBST(INTROSPECTION_GIRDIR)
+    AC_SUBST(INTROSPECTION_TYPELIBDIR)
+
+    AM_CONDITIONAL(HAVE_INTROSPECTION, test "x$found_introspection" = "xyes")
+])
+
+
+dnl Usage:
+dnl   GOBJECT_INTROSPECTION_CHECK([minimum-g-i-version])
+
+AC_DEFUN([GOBJECT_INTROSPECTION_CHECK],
+[
+  _GOBJECT_INTROSPECTION_CHECK_INTERNAL([$1])
+])
+
+dnl Usage:
+dnl   GOBJECT_INTROSPECTION_REQUIRE([minimum-g-i-version])
+
+
+AC_DEFUN([GOBJECT_INTROSPECTION_REQUIRE],
+[
+  _GOBJECT_INTROSPECTION_CHECK_INTERNAL([$1], [require])
+])
--- libindicate-0.2.3/libindicate-gtk/Makefile.am.wiget	2009-09-04 20:59:32.000000000 +0200
+++ libindicate-0.2.3/libindicate-gtk/Makefile.am	2009-12-07 20:32:36.000000000 +0100
@@ -38,35 +38,45 @@ libindicate_gtk_la_LIBADD = \
 pkgconfig_DATA = indicate-gtk.pc
 pkgconfigdir = $(libdir)/pkgconfig
 
-if USE_GIR
+CLEANFILES = 
 
-gobjectintrospection_gir_DATA = \
-	Indicate-gtk-0.1.gir
-gobjectintrospection_girdir = $(datadir)/gir
-
-gobjectintrospection_type_DATA = \
-	Indicate-gtk-0.1.typelib
-gobjectintrospection_typedir = $(libdir)/girepository
-
-irscanner_headers = $(patsubst %,$(srcdir)/%,$(indicate_headers))
-Indicate-gtk-0.1.gir: $(irscanner_headers)
-	$(G_IR_SCANNER) \
+if HAVE_INTROSPECTION
+
+BUILT_GIRSOURCES = 
+
+irscanner_headers = $(patsubst %,$(srcdir)/%,$(indicate_gtk_headers))
+
+IndicateGtk-0.2.gir: $(INTROSPECTION_SCANNER) $(irscanner_headers) Makefile.am
+	$(INTROSPECTION_SCANNER) \
 		-v --namespace IndicateGtk \
-		--nsversion=0.1 \
+		--nsversion=0.2 \
 		--add-include-path=$(srcdir) \
 		--include=GObject-2.0 \
 		--include=GLib-2.0 \
 		--include=GdkPixbuf-2.0 \
-		--library=indicate --pkg indicate \
-		--output Indicate-gtk-0.1.gir $(irscanner_headers)
+		--include=Indicate-0.2 \
+		--add-include-path=$(top_builddir)/libindicate \
+		-I $(top_srcdir) -L $(top_builddir)/libindicate \
+		--libtool="$(LIBTOOL)" \
+		--library=indicate-gtk --pkg indicate-gtk \
+		--output IndicateGtk-0.2.gir $(irscanner_headers)
+
+BUILT_GIRSOURCES += IndicateGtk-0.2.gir
+
+girdir = $(datadir)/gir-1.0
+gir_DATA = $(BUILT_GIRSOURCES)
+
+typelibsdir = $(libdir)/girepository-1.0
+typelibs_DATA = $(BUILT_GIRSOURCES:.gir=.typelib)
+
+%.typelib: %.gir $(INTROSPECTION_COMPILER)
+	$(INTROSPECTION_COMPILER) \
+		--includedir=$(srcdir) \
+		--includedir=. \
+		--includedir=$(top_builddir)/libindicate \
+		$(INTROSPECTION_COMPILER_OPTS) \
+		$< -o $(@F)
 
-Indicate-gtk-0.1.typelib: Indicate-gtk-0.1.gir
-	$(G_IR_COMPILER) \
-		--includedir=$(srcdir) Indicate-gtk-0.1.gir \
-		-o Indicate-gtk-0.1.typelib
-
-DISTCLEANFILES = \
-	Indicate-gtk-0.1.gir \
-	Indicate-gtk-0.1.typelib
+CLEANFILES += $(BUILT_GIRSOURCES) $(typelibs_DATA)
 
 endif
--- libindicate-0.2.3/libindicate/Makefile.am.wiget	2009-09-04 20:59:32.000000000 +0200
+++ libindicate-0.2.3/libindicate/Makefile.am	2009-12-07 20:30:38.000000000 +0100
@@ -152,19 +152,14 @@ CLEANFILES = \
 	s-enum-types-c \
 	s-enum-types-h
 
-if USE_GIR
+if HAVE_INTROSPECTION
 
-gobjectintrospection_gir_DATA = \
-	Indicate-0.2.gir
-gobjectintrospection_girdir = $(datadir)/gir
-
-gobjectintrospection_type_DATA = \
-	Indicate-0.2.typelib
-gobjectintrospection_typedir = $(libdir)/girepository
+BUILT_GIRSOURCES = 
 
 irscanner_headers = $(patsubst %,$(srcdir)/%,$(indicate_headers))
-Indicate-0.2.gir: $(irscanner_headers) Makefile
-	$(G_IR_SCANNER) \
+
+Indicate-0.2.gir: $(INTROSPECTION_SCANNER) $(irscanner_headers) Makefile.am
+	$(INTROSPECTION_SCANNER) \
 		-v --namespace Indicate \
 		--nsversion=0.2 \
 		--add-include-path=$(srcdir) \
@@ -174,13 +169,21 @@ Indicate-0.2.gir: $(irscanner_headers) M
 		--library=indicate --pkg indicate \
 		--output Indicate-0.2.gir $(irscanner_headers)
 
-Indicate-0.2.typelib: Indicate-0.2.gir
-	$(G_IR_COMPILER) \
-		--includedir=$(srcdir) Indicate-0.2.gir \
-		-o Indicate-0.2.typelib
-
-DISTCLEANFILES = \
-	Indicate-0.2.gir \
-	Indicate-0.2.typelib
+BUILT_GIRSOURCES += Indicate-0.2.gir
+
+girdir = $(datadir)/gir-1.0
+gir_DATA = $(BUILT_GIRSOURCES)
+
+typelibsdir = $(libdir)/girepository-1.0
+typelibs_DATA = $(BUILT_GIRSOURCES:.gir=.typelib)
+
+%.typelib: %.gir $(INTROSPECTION_COMPILER)
+	$(INTROSPECTION_COMPILER) \
+		--includedir=$(srcdir) \
+		--includedir=. \
+		$(INTROSPECTION_COMPILER_OPTS) \
+		$< -o $(@F)
+
+CLEANFILES += $(BUILT_GIRSOURCES) $(typelibs_DATA)
 
 endif
